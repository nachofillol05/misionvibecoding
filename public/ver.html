<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Mapa de Casas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <!-- Bootstrap (solo para estilos básicos) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }

    #map {
      height: 100vh;
      width: 100%;
    }

    .leaflet-tooltip.usuario-label {
      background-color: rgba(255,255,255,0.85);
      border: 1px solid #ccc;
      padding: 2px 6px;
      font-size: 12px;
      border-radius: 4px;
      pointer-events: none;
    }
  </style>
</head>
<body>

  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    /* ================== CONFIG ================== */

    const estadoColores = {
      visitada: 'green',
      no_atendieron: 'orange',
      otro: 'gray'
    };

    const coloresUsuarios = {};
    const coloresDisponibles = [
      '#e6194b', '#3cb44b', '#ffe119', '#4363d8', '#f58231',
      '#911eb4', '#46f0f0', '#f032e6', '#bcf60c', '#fabebe',
      '#008080', '#e6beff', '#9a6324', '#fffac8', '#800000'
    ];

    function getColorUsuario(usuario) {
      if (!usuario) return 'black';
      if (!coloresUsuarios[usuario]) {
        coloresUsuarios[usuario] =
          coloresDisponibles[
            Object.keys(coloresUsuarios).length % coloresDisponibles.length
          ];
      }
      return coloresUsuarios[usuario];
    }

    /* ================== MAPA ================== */

    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '© OpenStreetMap'
    });

    const satelite = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
      maxZoom: 18,
      subdomains: ['mt0','mt1','mt2','mt3'],
      attribution: '© Google'
    });

    const mapa = L.map('map', {
      center: [-31.61803, -64.38955],
      zoom: 15,
      maxZoom: 18,
      layers: [osm]
    });

    let capaSateliteActiva = false;
    let marcadores = [];
    let tooltips = [];

    /* ================== UTIL ================== */

    function toLocalDate(fechaStr) {
      if (!fechaStr) return '(sin fecha)';
      const [y, m, d] = fechaStr.split('T')[0].split('-');
      return `${d}/${m}/${y}`;
    }

    /* ================== CARGAR CASAS ================== */

    async function cargarCasas() {
      try {
        const res = await fetch('/casas');
        const casas = await res.json();

        marcadores.forEach(m => mapa.removeLayer(m));
        tooltips.forEach(t => mapa.removeLayer(t));
        marcadores = [];
        tooltips = [];

        const porUsuario = {};

        casas.forEach(casa => {
          const marker = L.circleMarker(
            [casa.latitud, casa.longitud],
            {
              radius: 8,
              color: getColorUsuario(casa.asignado_a),
              fillColor: estadoColores[casa.estado] || 'gray',
              fillOpacity: 0.8,
              weight: casa.asignado_a ? 2 : 1
            }
          ).addTo(mapa);

          marker.bindPopup(`
            <b>${casa.direccion}</b><br>
            Estado: ${casa.estado || '(sin estado)'}<br>
            Asignado a: ${casa.asignado_a || 'nadie'}<br>
            Día: ${toLocalDate(casa.fecha_asignacion)}<br>
            <hr>
            <b>Comentario:</b><br>
            ${casa.comentario ? casa.comentario : '<i>Sin comentario</i>'}
          `);

          marker.on('click', () => marker.openPopup());

          if (casa.asignado_a) {
            if (!porUsuario[casa.asignado_a]) porUsuario[casa.asignado_a] = [];
            porUsuario[casa.asignado_a].push([casa.latitud, casa.longitud]);
          }

          marcadores.push(marker);
        });

        // Tooltips por usuario
        for (const [usuario, coords] of Object.entries(porUsuario)) {
          const centro = coords
            .reduce((acc, c) => [acc[0] + c[0], acc[1] + c[1]], [0, 0])
            .map(x => x / coords.length);

          const tooltip = L.tooltip({
            permanent: true,
            direction: 'top',
            className: 'usuario-label'
          })
          .setLatLng(centro)
          .setContent(usuario)
          .addTo(mapa);

          tooltips.push(tooltip);
        }

      } catch (err) {
        console.error('Error cargando casas:', err);
      }
    }

    /* ================== INIT ================== */

    cargarCasas();
    setInterval(cargarCasas, 5000);

  </script>
</body>
</html>
