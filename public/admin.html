<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Admin</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 90vh; }
    .panel { padding: 10px; }
    .seleccionado { stroke: black; stroke-width: 3px; }
  </style>
</head>
<body>
  <div class="panel">
    Usuario a asignar: <input type="text" id="usuarioAsignar">
    <button id="btnAsignar">Asignar</button>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const estadoColores = {
      visitada: 'green',
      no_atendieron: 'orange',
      otro: 'gray'
    };

    const mapa = L.map('map').setView([-31.2422, -64.4722], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapa);

    let marcadores = [];
    let seleccionadas = new Set();

    async function cargarCasas() {
      const res = await fetch('/casas');
      const casas = await res.json();

      marcadores.forEach(m => mapa.removeLayer(m));
      marcadores = [];

      casas.forEach(casa => {
        const color = estadoColores[casa.estado] || 'gray';
        const borde = casa.asignado_a ? 'blue' : 'black';

        const marker = L.circleMarker([casa.latitud, casa.longitud], {
          radius: 8,
          color: borde,
          fillColor: color,
          fillOpacity: 0.8,
          casaId: casa.id
        }).addTo(mapa);

        marker.on('click', () => {
          if (seleccionadas.has(casa.id)) {
            seleccionadas.delete(casa.id);
            marker.setStyle({ weight: 1 });
          } else {
            seleccionadas.add(casa.id);
            marker.setStyle({ weight: 3 });
          }
        });

        marker.bindPopup(`
          <b>${casa.direccion}</b><br>
          Estado: ${casa.estado}<br>
          Asignado a: ${casa.asignado_a || 'nadie'}
        `);

        marcadores.push(marker);
      });
    }

    document.getElementById('btnAsignar').addEventListener('click', async () => {
      const usuario = document.getElementById('usuarioAsignar').value.trim();
      if (!usuario) return alert('Ingresá un nombre de usuario');
      if (!seleccionadas.size) return alert('Seleccioná al menos una casa');

      const casaIds = [...seleccionadas];

      const res = await fetch('/asignar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ casaIds, usuario }),
      });

      if (res.ok) {
        alert('Casas asignadas');
        seleccionadas.clear();
        cargarCasas();
      } else {
        alert('Error al asignar');
      }
    });

    cargarCasas();
  </script>
</body>
</html>
