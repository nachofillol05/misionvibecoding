<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Admin - Asignar Casas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    #map { height: 80vh; width: 100%; }
    .panel { padding: 10px; text-align: center; margin-bottom: 10px; }
    .panel > * { margin: 5px; }
    .user-label {
      position: absolute;
      background: rgba(255,255,255,0.7);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
      pointer-events: none;
      transition: opacity 0.3s;
    }
  </style>
</head>
<body>
  <div class="panel container d-flex justify-content-center flex-wrap gap-2">
    <input list="usuariosList" id="usuarioFilter" class="form-control" placeholder="Filtrar por usuario" style="max-width: 200px;" />
    <datalist id="usuariosList"></datalist>
    <button id="btnClearFilter" class="btn btn-outline-secondary">Quitar filtro</button>
    <input type="text" id="usuarioAsignar" class="form-control" placeholder="Usuario a asignar" style="max-width: 200px;" />
    <button id="btnAsignar" class="btn btn-primary">Asignar</button>
    <button id="btnDesasignar" class="btn btn-warning">Desasignar seleccionadas</button>
    <button id="btnToggleVisitadas" class="btn btn-secondary">Ocultar visitadas</button>
    <button id="btnVerEstadisticas" class="btn btn-info">Ver estadísticas</button>
    <button id="btnToggleSatelite" class="btn btn-outline-secondary">Mapa Satelital</button>
    <button id="btnModoEdicion" class="btn btn-outline-secondary">Modo edición</button>
  </div>
  <div id="map" class="container-fluid px-0"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
  <script>
    // utils
    function hashColor(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
      const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
      return "#" + "00000".substring(0, 6 - c.length) + c;
    }

    const estadoColores = { visitada: 'green', no_atendieron: 'orange', otro: 'gray' };
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18,attribution:'© OpenStreetMap'});
    const sat = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{maxZoom:18,subdomains:['mt0','mt1','mt2','mt3'],attribution:'© Google Satellite'});
    const map = L.map('map',{center:[-31.2422,-64.4722],zoom:15,maxZoom:18,layers:[osm]});
    let satAct = false, markers = [], selected = new Set(), showVisited = true;

    // label container
    const labelContainer = document.createElement('div');
    labelContainer.style.position = 'absolute';
    labelContainer.style.top = 0;
    labelContainer.style.left = 0;
    labelContainer.style.width = '100%';
    labelContainer.style.height = '100%';
    labelContainer.style.pointerEvents = 'none';
    document.body.appendChild(labelContainer);

    // controls
    document.getElementById('btnToggleSatelite').onclick = () => {
      satAct = !satAct;
      satAct ? map.addLayer(sat) : map.removeLayer(sat);
      satAct ? this.innerText = 'Mapa Normal' : this.innerText = 'Mapa Satelital';
    };
    document.getElementById('btnToggleVisitadas').onclick = () => { showVisited = !showVisited; this.innerText = showVisited ? 'Ocultar visitadas' : 'Mostrar visitadas'; load(); };
    document.getElementById('btnVerEstadisticas').onclick = () => location.href = '/estadisticas.html';
    document.getElementById('btnModoEdicion').onclick = () => location.href = '/editar.html';
    document.getElementById('btnClearFilter').onclick = () => { document.getElementById('usuarioFilter').value = ''; load(); };
    document.getElementById('usuarioFilter').oninput = () => load();

    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);
    map.addControl(new L.Control.Draw({draw:{rectangle:true,polygon:true},edit:{featureGroup:drawnItems,edit:false,remove:false}}));
    map.on('draw:created', e => {
      drawnItems.clearLayers(); drawnItems.addLayer(e.layer);
      selected.clear();
      markers.forEach(m => {
        const inBounds = e.layer.getBounds().contains(m.getLatLng());
        if(inBounds) { selected.add(m.options.casaId); m.setStyle({ weight:4, color: m.options.userColor }); }
        else m.setStyle({ weight: m.options.asignado?2:1, color: m.options.userColor });
      });
    });

    document.getElementById('btnAsignar').onclick = async () => {
      const usu = document.getElementById('usuarioAsignar').value.trim();
      if(!usu || selected.size===0) return alert('Faltan datos');
      await fetch('/asignar',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({usuario:usu,ids:[...selected]})});
      selected.clear(); load();
    };

    document.getElementById('btnDesasignar').onclick = async () => {
      if(selected.size===0) return alert('Nada seleccionado');
      if(!confirm('Desasignar?')) return;
      await fetch('/desasignar',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ids:[...selected]})});
      selected.clear(); load();
    };

    // load function
    async function load(){
      const usuFilter = document.getElementById('usuarioFilter').value.trim().toLowerCase();
      const res = await fetch('/casas');
      const casas = await res.json();
      markers.forEach(m=>map.removeLayer(m)); markers=[];
      labelContainer.innerHTML = '';

      // build datalist
      const users = [...new Set(casas.filter(c=>c.asignado_a).map(c=>c.asignado_a))];
      const ddl = document.getElementById('usuariosList');
      ddl.innerHTML = users.map(u=>`<option value="${u}">`).join('');

      const grouped = {};
      casas.filter(c=> showVisited || c.estado!='visitada').filter(c=> !usuFilter || c.asignado_a?.toLowerCase()===usuFilter).forEach(c=>{
        const uc = hashColor(c.asignado_a || '');
        const mk = L.circleMarker([c.latitud,c.longitud],{radius:8,fillColor:estadoColores[c.estado]||'gray',color:c.asignado_a?uc:'black',fillOpacity:0.8,weight:c.asignado_a?2:1}).addTo(map);
        mk.bindPopup(`<b>${c.direccion}</b><br>Asignado: ${c.asignado_a||'nadie'}`);
        mk.options = { casaId:c.id, asignado:!!c.asignado_a, userColor:mk.options.color };
        markers.push(mk);
        if(c.asignado_a){
          grouped[c.asignado_a] = grouped[c.asignado_a] || [];
          grouped[c.asignado_a].push(mk);
        }
      });

      // add labels
      for(const usr in grouped){
        const list = grouped[usr];
        const latSum = list.reduce((s,m)=>s+m.getLatLng().lat,0)/list.length;
        const lngSum = list.reduce((s,m)=>s+m.getLatLng().lng,0)/list.length;
        const point = map.latLngToContainerPoint([latSum,lngSum]);
        const div = document.createElement('div');
        div.className='user-label';
        div.style.left = point.x+'px'; div.style.top = point.y+'px';
        div.style.border = `1px solid ${hashColor(usr)}`;
        div.innerText = usr;
        div.onmouseenter = ()=> div.style.opacity='0';
        div.onmouseleave = ()=> div.style.opacity='1';
        labelContainer.appendChild(div);
      }
    }

    load();
  </script>
</body>
</html>
