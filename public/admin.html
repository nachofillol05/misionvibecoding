<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Admin - Asignar Casas</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <style>
    #map { height: 90vh; width: 100%; }
    .panel { padding: 10px; text-align: center; }
    .panel input, .panel button { margin: 5px; }
  </style>
</head>
<body>
  <div class="panel">
    <input type="text" id="usuarioAsignar" class="form-control d-inline w-auto" placeholder="Usuario a asignar">
    <button class="btn btn-primary" id="btnAsignar">Asignar</button>
    <button class="btn btn-danger" id="btnDesasignar">Desasignar</button>
    <button class="btn btn-secondary" id="btnToggleVisitadas">Ocultar visitadas</button>
    <a href="estadisticas.html" class="btn btn-success">Ver estadísticas</a>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const estadoColores = { visitada: 'green', no_atendieron: 'orange', otro: 'gray' };
    let ocultarVisitadas = false;
    let seleccionadas = new Set();
    let marcadores = [];

    const mapa = L.map('map', {
      center: [-31.2422, -64.4722],
      zoom: 15,
      maxZoom: 19
    });

    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapa);
    const sat = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
      subdomains: ['mt0', 'mt1', 'mt2'],
      attribution: 'Google Satellite',
      maxZoom: 19
    });

    L.control.layers({ "OSM": osm, "Satélite": sat }).addTo(mapa);

    const drawnItems = new L.FeatureGroup();
    mapa.addLayer(drawnItems);

    const drawControl = new L.Control.Draw({
      draw: {
        rectangle: true,
        polygon: true,
        marker: false,
        circle: false,
        polyline: false,
        circlemarker: false
      },
      edit: {
        featureGroup: drawnItems,
        edit: false,
        remove: false
      }
    });
    mapa.addControl(drawControl);

    mapa.on('draw:created', function (e) {
      const layer = e.layer;
      drawnItems.clearLayers();
      drawnItems.addLayer(layer);
      seleccionadas.clear();

      marcadores.forEach(marker => {
        if (layer.getBounds().contains(marker.getLatLng())) {
          seleccionadas.add(marker.options.casaId);
          marker.setStyle({ weight: 3 });
        } else {
          marker.setStyle({ weight: marker.options.asignado ? 2 : 1 });
        }
      });
    });

    async function cargarCasas() {
      const res = await fetch('/casas');
      const casas = await res.json();

      marcadores.forEach(m => mapa.removeLayer(m));
      marcadores = [];

      casas.forEach(casa => {
        if (ocultarVisitadas && casa.estado === 'visitada') return;

        const marker = L.circleMarker([casa.latitud, casa.longitud], {
          radius: 8,
          color: casa.asignado_a ? 'blue' : 'black',
          fillColor: estadoColores[casa.estado] || 'gray',
          fillOpacity: 0.8,
          weight: casa.asignado_a ? 2 : 1,
          casaId: casa.id,
          asignado: !!casa.asignado_a
        }).addTo(mapa);

        marker.bindPopup(`<b>${casa.direccion}</b><br>Estado: ${casa.estado || '-'}<br>Asignado a: ${casa.asignado_a || 'nadie'}`);
        marcadores.push(marker);
      });
    }

    document.getElementById('btnAsignar').addEventListener('click', async () => {
      const usuario = document.getElementById('usuarioAsignar').value.trim();
      if (!usuario || seleccionadas.size === 0) return alert('Faltan datos o selección');
      const res = await fetch('/asignar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ usuario, ids: [...seleccionadas] })
      });
      if (res.ok) {
        alert('Casas asignadas');
        seleccionadas.clear();
        cargarCasas();
      }
    });

    document.getElementById('btnDesasignar').addEventListener('click', async () => {
      if (seleccionadas.size === 0) return alert('Selecciona casas para desasignar');
      if (!confirm('¿Seguro quieres desasignar estas casas?')) return;
      const res = await fetch('/desasignar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ids: [...seleccionadas] })
      });
      if (res.ok) {
        alert('Casas desasignadas');
        seleccionadas.clear();
        cargarCasas();
      }
    });

    document.getElementById('btnToggleVisitadas').addEventListener('click', () => {
      ocultarVisitadas = !ocultarVisitadas;
      document.getElementById('btnToggleVisitadas').innerText = ocultarVisitadas ? 'Mostrar visitadas' : 'Ocultar visitadas';
      cargarCasas();
    });

    const socket = io();
    socket.on('actualizacion', cargarCasas);

    cargarCasas();
  </script>
</body>
</html>
