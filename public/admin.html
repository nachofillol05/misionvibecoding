<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin - Asignar Casas</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <style>
    #map { height: 90vh; }
  </style>
</head>
<body class="bg-light">
  <div class="container-fluid py-3">
    <div class="row mb-2">
      <div class="col-sm-6">
        <input type="text" id="usuarioAsignar" placeholder="Usuario a asignar" class="form-control" />
      </div>
      <div class="col-sm-6 text-end">
        <button class="btn btn-primary" id="btnAsignar">Asignar</button>
        <button class="btn btn-danger" id="btnDesasignar">Desasignar seleccionadas</button>
        <button class="btn btn-outline-secondary" id="toggleVisitadas">Ocultar visitadas</button>
      </div>
    </div>
    <div id="map"></div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    const socket = io();
    const estadoColores = {
      visitada: "green",
      no_atendieron: "orange",
      otro: "gray"
    };

    const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "© OpenStreetMap contributors"
    });

    const satelite = L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", {
      attribution: "© Esri",
      maxZoom: 20
    });

    const mapa = L.map("map", {
      center: [-31.2422, -64.4722],
      zoom: 16,
      layers: [osm]
    });

    L.control.layers({
      "Mapa": osm,
      "Satelital": satelite
    }).addTo(mapa);

    let marcadores = [];
    let seleccionadas = new Set();
    let mostrarVisitadas = true;

    const drawnItems = new L.FeatureGroup();
    mapa.addLayer(drawnItems);

    const drawControl = new L.Control.Draw({
      draw: {
        rectangle: true,
        polygon: true,
        circle: false,
        marker: false,
        polyline: false,
        circlemarker: false
      },
      edit: { featureGroup: drawnItems, edit: false, remove: false }
    });

    mapa.addControl(drawControl);

    mapa.on("draw:created", (e) => {
      const layer = e.layer;
      drawnItems.clearLayers();
      drawnItems.addLayer(layer);
      seleccionadas.clear();

      marcadores.forEach(marker => {
        const latlng = marker.getLatLng();
        const dentro = (
          layer instanceof L.Rectangle
            ? layer.getBounds().contains(latlng)
            : layer.getLatLngs && L.polygon(layer.getLatLngs()).getBounds().contains(latlng)
        );

        if (dentro) {
          seleccionadas.add(marker.options.casaId);
          marker.setStyle({ weight: 3 });
        } else {
          marker.setStyle({ weight: marker.options.asignado ? 2 : 1 });
        }
      });
    });

    async function cargarCasas() {
      const res = await fetch("/casas");
      const casas = await res.json();

      marcadores.forEach(m => mapa.removeLayer(m));
      marcadores = [];

      casas.forEach(casa => {
        if (!mostrarVisitadas && casa.estado === "visitada") return;

        const color = estadoColores[casa.estado] || "gray";

        const marker = L.circleMarker([casa.latitud, casa.longitud], {
          radius: 8,
          color: casa.asignado_a ? "blue" : "black",
          fillColor: color,
          fillOpacity: 0.8,
          weight: casa.asignado_a ? 2 : 1,
          casaId: casa.id,
          asignado: !!casa.asignado_a
        }).addTo(mapa);

        marker.bindPopup(`
          <b>${casa.direccion}</b><br>
          Estado: ${casa.estado || "(sin estado)"}<br>
          Asignado a: ${casa.asignado_a || "nadie"}
        `);

        marcadores.push(marker);
      });
    }

    document.getElementById("btnAsignar").addEventListener("click", async () => {
      const usuario = document.getElementById("usuarioAsignar").value.trim();
      if (!usuario || seleccionadas.size === 0) return alert("Faltan datos");

      const res = await fetch("/asignar", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ usuario, ids: [...seleccionadas] })
      });

      if (res.ok) {
        alert("Casas asignadas");
        seleccionadas.clear();
        cargarCasas();
      }
    });

    document.getElementById("btnDesasignar").addEventListener("click", async () => {
      if (seleccionadas.size === 0) return alert("No hay casas seleccionadas para desasignar");
      if (!confirm("¿Seguro que querés desasignar estas casas?")) return;

      const res = await fetch("/desasignar", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ids: [...seleccionadas] })
      });

      if (res.ok) {
        alert("Casas desasignadas");
        seleccionadas.clear();
        cargarCasas();
      }
    });

    document.getElementById("toggleVisitadas").addEventListener("click", () => {
      mostrarVisitadas = !mostrarVisitadas;
      document.getElementById("toggleVisitadas").textContent = mostrarVisitadas ? "Ocultar visitadas" : "Mostrar visitadas";
      cargarCasas();
    });

    socket.on("actualizacion", cargarCasas);
    cargarCasas();
  </script>
</body>
</html>
