<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin - Misiones Casas</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css" />
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    #controles {
      padding: 10px;
      background: #f0f0f0;
    }
    button {
      margin-right: 10px;
      margin-top: 5px;
      padding: 5px 10px;
      cursor: pointer;
    }
    input {
      padding: 5px;
      width: 200px;
    }
  </style>
</head>
<body>
  <div id="controles">
    <input type="text" id="usuarioAsignar" placeholder="Nombre usuario para asignar" />
    <button id="btnAsignar">Asignar casas seleccionadas</button>
    <button id="btnDesasignar">Desasignar casas seleccionadas</button>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>
  <script src="/socket.io/socket.io.js"></script>

  <script>
    const socket = io();

    // Inicializamos mapa centrado en Cosquín
    const map = L.map('map').setView([-31.4265, -64.4572], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let casas = [];
    const markers = new Map();
    const seleccionados = new Set();

    // Colores por estado y asignacion
    function getColor(casa) {
      if (seleccionados.has(casa.id)) return 'orange'; // selección activa
      if (!casa.asignado_a) return 'gray'; // sin asignar
      switch (casa.estado) {
        case 'visitada': return 'green';
        case 'no atendieron': return 'red';
        case 'otro': return 'yellow';
        default: return 'blue';
      }
    }

    // Limpia marcadores del mapa
    function clearMarkers() {
      markers.forEach(m => map.removeLayer(m));
      markers.clear();
      seleccionados.clear();
    }

    // Dibuja los marcadores con colores y bindPopup
    function pintarCasas() {
      clearMarkers();
      casas.forEach(casa => {
        const color = getColor(casa);
        const marker = L.circleMarker([casa.latitud, casa.longitud], {
          radius: 8,
          color,
          fillColor: color,
          fillOpacity: 0.8,
          weight: 2,
          opacity: 1
        }).addTo(map);

        // Toggle selección al hacer click en marcador
        marker.on('click', () => {
          if (seleccionados.has(casa.id)) {
            seleccionados.delete(casa.id);
          } else {
            seleccionados.add(casa.id);
          }
          pintarCasas();
        });

        // Popup con info
        const popupHTML = `
          <b>${casa.direccion}</b><br/>
          Estado: ${casa.estado || 'sin estado'}<br/>
          Asignado a: ${casa.asignado_a || 'Nadie'}<br/>
          Comentario: ${casa.comentario || '(vacío)'}
        `;
        marker.bindPopup(popupHTML);

        markers.set(casa.id, marker);
      });
    }

    // Carga las casas del backend
    async function cargarCasas() {
      try {
        const res = await fetch('/casas');
        casas = await res.json();
        pintarCasas();
      } catch {
        alert('Error cargando casas');
      }
    }

    // Leaflet.draw para selección rectangular
    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    const drawControl = new L.Control.Draw({
      draw: {
        polygon: false,
        polyline: false,
        circle: false,
        circlemarker: false,
        marker: false,
        rectangle: true
      },
      edit: false,
    });
    map.addControl(drawControl);

    map.on(L.Draw.Event.CREATED, e => {
      const layer = e.layer;
      drawnItems.clearLayers();
      drawnItems.addLayer(layer);

      seleccionados.clear();

      const bounds = layer.getBounds();

      casas.forEach(casa => {
        if (bounds.contains([casa.latitud, casa.longitud])) {
          seleccionados.add(casa.id);
        }
      });
      pintarCasas();
    });

    // Botón asignar
    document.getElementById('btnAsignar').addEventListener('click', async () => {
      const usuario = document.getElementById('usuarioAsignar').value.trim();
      if (!usuario) {
        alert('Ingresá un nombre de usuario');
        return;
      }
      if (seleccionados.size === 0) {
        alert('No hay casas seleccionadas');
        return;
      }

      try {
        const res = await fetch('/asignar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ids: Array.from(seleccionados), usuario })
        });
        if (res.ok) {
          alert('Casas asignadas');
          seleccionados.clear();
          drawnItems.clearLayers();
          cargarCasas();
        } else {
          alert('Error asignando casas');
        }
      } catch {
        alert('Error asignando casas');
      }
    });

    // Botón desasignar
    document.getElementById('btnDesasignar').addEventListener('click', async () => {
      if (seleccionados.size === 0) {
        alert('No hay casas seleccionadas');
        return;
      }
      if (!confirm('¿Desasignar casas seleccionadas? Se borrarán estado y comentario.')) {
        return;
      }
      try {
        const res = await fetch('/desasignar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ids: Array.from(seleccionados) })
        });
        if (res.ok) {
          alert('Casas desasignadas');
          seleccionados.clear();
          drawnItems.clearLayers();
          cargarCasas();
        } else {
          alert('Error desasignando casas');
        }
      } catch {
        alert('Error desasignando casas');
      }
    });

    socket.on('actualizacion', cargarCasas);

    cargarCasas();
  </script>
</body>
</html>
