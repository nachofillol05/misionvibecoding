<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin - Misiones Casas</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css" />
  <style>
    #map { height: 80vh; width: 100%; margin-bottom: 1rem; }
    #controles { margin: 10px; }
    button { margin-right: 10px; }
  </style>
</head>
<body>
  <h2>Panel Admin - Asignar y Desasignar Casas</h2>
  <div id="controles">
    <input type="text" id="usuarioAsignar" placeholder="Nombre usuario para asignar" />
    <button id="btnAsignar">Asignar casas seleccionadas</button>
    <button id="btnDesasignar">Desasignar casas seleccionadas</button>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>
  <script src="/socket.io/socket.io.js"></script>

  <script>
    const socket = io();

    let map = L.map('map').setView([-31.4265, -64.4572], 13); // Centro en Cosquín
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let casas = [];
    let markers = new Map(); // id => marker
    let seleccionados = new Set();

    // Colores por estado y asignacion
    function getColor(casa) {
      if (seleccionados.has(casa.id)) return 'orange'; // selección activa
      if (!casa.asignado_a) return 'gray'; // sin asignar
      switch (casa.estado) {
        case 'visitada': return 'green';
        case 'no atendieron': return 'red';
        case 'otro': return 'yellow';
        default: return 'blue';
      }
    }

    function clearMarkers() {
      markers.forEach(marker => map.removeLayer(marker));
      markers.clear();
      seleccionados.clear();
    }

    function pintarCasas() {
      clearMarkers();
      casas.forEach(casa => {
        const color = getColor(casa);
        const marker = L.circleMarker([casa.latitud, casa.longitud], {
          radius: 8,
          color,
          fillColor: color,
          fillOpacity: 0.8,
        }).addTo(map);

        marker.on('click', () => {
          if (seleccionados.has(casa.id)) {
            seleccionados.delete(casa.id);
          } else {
            seleccionados.add(casa.id);
          }
          pintarCasas();
        });

        marker.bindPopup(`
          <b>${casa.direccion}</b><br/>
          Estado: ${casa.estado || 'sin estado'}<br/>
          Asignado a: ${casa.asignado_a || 'Nadie'}<br/>
          Comentario: ${casa.comentario || '(vacío)'}
        `);

        markers.set(casa.id, marker);
      });
    }

    async function cargarCasas() {
      try {
        const res = await fetch('/casas');
        casas = await res.json();
        pintarCasas();
      } catch (err) {
        alert('Error cargando casas');
      }
    }

    // Leaflet.draw para seleccionar con rectángulo
    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    const drawControl = new L.Control.Draw({
      draw: {
        polygon: false,
        polyline: false,
        circle: false,
        marker: false,
        circlemarker: false,
        rectangle: true,
      },
      edit: false,
    });
    map.addControl(drawControl);

    map.on(L.Draw.Event.CREATED, e => {
      const layer = e.layer;
      drawnItems.clearLayers(); // solo 1 selección a la vez para simplificar
      drawnItems.addLayer(layer);

      seleccionados.clear();

      // Obtener bounds del rectángulo
      const bounds = layer.getBounds();

      // Marcar todos los markers dentro del rectángulo como seleccionados
      casas.forEach(casa => {
        if (bounds.contains([casa.latitud, casa.longitud])) {
          seleccionados.add(casa.id);
        }
      });
      pintarCasas();
    });

    document.getElementById('btnAsignar').addEventListener('click', async () => {
      const usuario = document.getElementById('usuarioAsignar').value.trim();
      if (!usuario) return alert('Ingresá un nombre de usuario');

      if (seleccionados.size === 0) return alert('No hay casas seleccionadas');

      try {
        const res = await fetch('/asignar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ids: Array.from(seleccionados), usuario }),
        });
        if (res.ok) {
          alert('Casas asignadas');
          seleccionados.clear();
          drawnItems.clearLayers();
          cargarCasas();
        } else {
          alert('Error asignando casas');
        }
      } catch {
        alert('Error asignando casas');
      }
    });

    document.getElementById('btnDesasignar').addEventListener('click', async () => {
      if (seleccionados.size === 0) return alert('No hay casas seleccionadas');

      if (!confirm('¿Desasignar casas seleccionadas? Se borrarán estado y comentario.')) return;

      try {
        const res = await fetch('/desasignar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ids: Array.from(seleccionados) }),
        });
        if (res.ok) {
          alert('Casas desasignadas');
          seleccionados.clear();
          drawnItems.clearLayers();
          cargarCasas();
        } else {
          alert('Error desasignando casas');
        }
      } catch {
        alert('Error desasignando casas');
      }
    });

    socket.on('actualizacion', cargarCasas);

    cargar
