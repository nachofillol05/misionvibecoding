<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Usuario - Casas asignadas</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <style>
    #map { height: 90vh; }
    .panel { padding: 10px; text-align: center; }
    .panel input, .panel button { margin: 5px; }
  </style>
</head>
<body>
  <div class="panel">
    <input type="text" id="usuario" class="form-control d-inline w-auto" placeholder="Tu nombre de usuario">
    <button class="btn btn-primary" id="btnCargar">Ver mis casas</button>
    <button class="btn btn-secondary" id="btnToggleVisitadas">Ocultar visitadas</button>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const estadoColores = { visitada: 'green', no_atendieron: 'orange', otro: 'gray' };
    let usuarioActual = '';
    let ocultarVisitadas = false;
    let mapa = L.map('map', {
      center: [-31.2422, -64.4722],
      zoom: 15,
      maxZoom: 19
    });

    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapa);
    const sat = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
      subdomains: ['mt0', 'mt1', 'mt2'],
      attribution: 'Google Satellite',
      maxZoom: 19
    });

    L.control.layers({ "OSM": osm, "SatÃ©lite": sat }).addTo(mapa);

    let marcadores = [];

    async function cargarCasas() {
      if (!usuarioActual) return;
      const res = await fetch(`/casas/${usuarioActual}`);
      const casas = await res.json();

      marcadores.forEach(m => mapa.removeLayer(m));
      marcadores = [];

      casas.forEach(casa => {
        if (ocultarVisitadas && casa.estado === 'visitada') return;

        const marker = L.circleMarker([casa.latitud, casa.longitud], {
          radius: 8,
          color: 'blue',
          fillColor: estadoColores[casa.estado] || 'gray',
          fillOpacity: 0.8
        }).addTo(mapa);

        const form = document.createElement('form');
        form.innerHTML = `
          <strong>${casa.direccion}</strong><br>
          <select class="form-select form-select-sm mt-1 estado">
            <option value="">(sin estado)</option>
            <option value="visitada">Visitada</option>
            <option value="no_atendieron">No atendieron</option>
            <option value="otro">Otro</option>
          </select>
          <textarea class="form-control mt-1 comentario" rows="2" placeholder="Comentario...">${casa.comentario || ''}</textarea>
          <button type="submit" class="btn btn-primary btn-sm mt-1">Guardar</button>
        `;

        form.querySelector('.estado').value = casa.estado || '';

        form.onsubmit = async e => {
          e.preventDefault();
          const estado = form.querySelector('.estado').value;
          const comentario = form.querySelector('.comentario').value;

          await fetch('/estado', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: casa.id, estado })
          });
          await fetch('/comentario', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: casa.id, comentario })
          });

          cargarCasas();
        };

        marker.bindPopup(form);
        marcadores.push(marker);
      });
    }

    document.getElementById('btnCargar').addEventListener('click', () => {
      usuarioActual = document.getElementById('usuario').value.trim();
      if (usuarioActual) cargarCasas();
    });

    document.getElementById('btnToggleVisitadas').addEventListener('click', () => {
      ocultarVisitadas = !ocultarVisitadas;
      document.getElementById('btnToggleVisitadas').innerText = ocultarVisitadas ? 'Mostrar visitadas' : 'Ocultar visitadas';
      cargarCasas();
    });

    const socket = io();
    socket.on('actualizacion', cargarCasas);
  </script>
</body>
</html>
