<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Usuario - Misiones Casas</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 80vh; width: 100%; margin-bottom: 1rem; }
    textarea { width: 100%; height: 50px; margin-top: 5px; }
    .estado-buttons button {
      margin-right: 5px;
      margin-top: 5px;
      padding: 5px 10px;
    }
  </style>
</head>
<body>
  <h2>Panel Usuario - Casas Asignadas</h2>
  <input type="text" id="usuario" placeholder="Ingres치 tu nombre" />
  <button id="btnCargar">Cargar Casas</button>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="/socket.io/socket.io.js"></script>

  <script>
    const socket = io();

    let map = null;
    let markers = new Map();
    let currentUsuario = null;

    function getColorForEstado(estado) {
      switch (estado) {
        case 'visitada': return 'green';
        case 'no atendieron': return 'red';
        case 'otro': return 'yellow';
        default: return 'blue';
      }
    }

    function clearMarkers() {
      markers.forEach(marker => map.removeLayer(marker));
      markers.clear();
    }

    function addMarker(casa) {
      const color = getColorForEstado(casa.estado);
      const marker = L.circleMarker([casa.latitud, casa.longitud], {
        radius: 8,
        color,
        fillColor: color,
        fillOpacity: 0.8,
      }).addTo(map);

      let popupContent = document.createElement('div');

      // Direcci칩n
      let direccionEl = document.createElement('b');
      direccionEl.textContent = casa.direccion;
      popupContent.appendChild(direccionEl);
      popupContent.appendChild(document.createElement('br'));

      // Estado botones
      let estadoDiv = document.createElement('div');
      estadoDiv.classList.add('estado-buttons');

      ['visitada', 'no atendieron', 'otro', ''].forEach(estado => {
        let btn = document.createElement('button');
        btn.textContent = estado || 'Sin estado';
        btn.style.backgroundColor = getColorForEstado(estado);
        btn.onclick = async () => {
          try {
            await fetch('/estado', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id: casa.id, estado }),
            });
            // Actualizaci칩n sin mover mapa ni centrar
          } catch {
            alert('Error actualizando estado');
          }
        };
        estadoDiv.appendChild(btn);
      });
      popupContent.appendChild(estadoDiv);

      // Comentarios
      let commentLabel = document.createElement('label');
      commentLabel.textContent = 'Comentario:';
      commentLabel.style.display = 'block';
      popupContent.appendChild(commentLabel);

      let commentInput = document.createElement('textarea');
      commentInput.value = casa.comentario || '';
      commentInput.onchange = async () => {
        try {
          await fetch('/comentario', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: casa.id, comentario: commentInput.value }),
          });
          // No mover mapa ni centrar
        } catch {
          alert('Error guardando comentario');
        }
      };
      popupContent.appendChild(commentInput);

      marker.bindPopup(popupContent);
      markers.set(casa.id, marker);
    }

    async function cargarCasas(usuario) {
      if (!usuario) return;

      try {
        const res = await fetch(`/casas/${usuario}`);
        if (!res.ok) {
          alert('Error cargando casas');
          return;
        }
        const casas = await res.json();

        if (!map) {
          map = L.map('map').setView([-31.4265, -64.4572], 13);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
          }).addTo(map);
        }

        clearMarkers();
        casas.forEach(addMarker);
      } catch (error) {
        alert('Error cargando casas');
      }
    }

    document.getElementById('btnCargar').addEventListener('click', () => {
      const usuario = document.getElementById('usuario').value.trim();
      if (!usuario) {
        alert('Ingres치 tu nombre');
        return;
      }
      currentUsuario = usuario;
      cargarCasas(usuario);
    });

    socket.on('actualizacion', () => {
      if (currentUsuario) cargarCasas(currentUsuario);
    });
  </script>
</body>
</html>
