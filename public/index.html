<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Misi√≥n de Visita</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 100vh; }
    .visited { background-color: green; }
    .no-response { background-color: orange; }
    .other { background-color: gray; }
  </style>
</head>
<body>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const usuario = prompt("Tu nombre:");

    const estadoColores = {
      visitada: 'green',
      no_atendieron: 'orange',
      otro: 'gray'
    };

    let mapa = L.map('map').setView([-31.2422, -64.4722], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapa);

    let marcadores = [];

    async function cargarCasas() {
      const res = await fetch('/casas?usuario=' + encodeURIComponent(usuario));
      const casas = await res.json();

      marcadores.forEach(m => mapa.removeLayer(m));
      marcadores = [];

      casas.forEach(casa => {
        const color = estadoColores[casa.estado] || 'gray';

        const marcador = L.circleMarker([casa.latitud, casa.longitud], {
          radius: 8,
          color: color,
          fillColor: color,
          fillOpacity: 0.8,
        }).addTo(mapa);

        marcador.bindPopup(`
          <b>${casa.direccion}</b><br>
          Estado: ${casa.estado}<br>
          <textarea id="comentario-${casa.id}" rows="2" cols="20" placeholder="Comentario..."></textarea><br>
          <button onclick="cambiarEstado(${casa.id}, 'visitada')">Visitada</button>
          <button onclick="cambiarEstado(${casa.id}, 'no_atendieron')">No atendieron</button>
          <button onclick="cambiarEstado(${casa.id}, 'otro')">Otro</button>
        `);

        marcadores.push(marcador);
      });
    }

    async function cambiarEstado(id, estado) {
      const comentario = document.getElementById(`comentario-${id}`).value;
      await fetch('/estado', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id, estado, comentario, usuario }),
      });
      cargarCasas();
    }

    cargarCasas();
  </script>
</body>
</html>
